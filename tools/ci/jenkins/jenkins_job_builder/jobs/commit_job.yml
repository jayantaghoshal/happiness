- defaults:
    name: commit_job_defaults
    project-type: freestyle
    concurrent: true
    description: DO NOT EDIT MANUALLY THROUGH JENKINS WEB UI - Config in vendor/volvocars/tools/ci/jenkins_job_builder
    parameters:
        # Jenkins require parameters to be explicitly defined, otherwise they are removed
        - string:
            name: ZUUL_UUID
            description: "Zuul provided key to link builds with Gerrit events."
        - string:
            name: ZUUL_REF
            description: "Zuul provided ref that includes commit(s) to build."
        - string:
            name: ZUUL_COMMIT
            description: "The commit SHA1 at the head of ZUUL_REF."
        - string:
            name: ZUUL_PROJECT
            description: "The project that triggered this build."
        - string:
            name: ZUUL_PIPELINE
            description: "The Zuul pipeline that is building this job."
        - string:
            name: ZUUL_URL
            description: "The URL for the zuul server as configured in zuul.conf. A test runner may use this URL as the basis for fetching git commits."
        - string:
            name: BASE_LOG_PATH
            description: "zuul suggests a path to store and address logs. This is deterministic and hence useful for where you want workers to upload to a specific destination or need them to have a specific final URL you can link to in advanced. For changes it is, (last-two-digits-of-change/change-number/patchset-number). For reference updates it is, (first-two-digits-of-newrev/newrev)"
        - string:
            name: LOG_PATH
            description: "zuul also suggests a unique path for logs to the worker. This is (BASE_LOG_PATH/pipeline-name/job-name/uuid)"
        - string:
            name: ZUUL_VOTING
            description: "Whether Zuul considers this job voting or not. Note that if Zuul is reconfigured during the run, the voting status of a job may change and this value will be out of date. Values are 1 if voting, 0 otherwise."
        - string:
            name: ZUUL_BRANCH
            description: "The target branch for the change that triggered this build."
        - string:
            name: ZUUL_CHANGE
            description: "The Gerrit change ID for the change that triggered this build."
        - string:
            name: ZUUL_CHANGES
            description: "A caret character separated list of the changes upon which this build is dependent upon in the form of a colon character separated list consisting of project name, target branch, and revision ref."
        - string:
            name: ZUUL_CHANGE_IDS
            description: "All of the Gerrit change IDs that are included in this build (useful when the DependentPipelineManager combines changes for testing)."
        - string:
            name: ZUUL_PATCHSET
            description: "The Gerrit patchset number for the change that triggered this build."
        - string:
            name: ZUUL_OLDREV
            description: "The SHA1 of the old revision at this ref ,recall the ref name is in ZUUL_REF."
        - string:
            name: ZUUL_NEWREV
            description: "The SHA1 of the new revision at this ref ,recall the ref name is in ZUUL_REF."
        - string:
            name: ZUUL_SHORT_OLDREV
            description: "The shortened 7 character SHA1 of the old revision."
        - string:
            name: ZUUL_SHORT_NEWREV
            description: "The shortened 7 character SHA1 of the new revision."
        - string:
            name: ZUUL_PATCHSET
            description: "The Gerrit patchset number for the change that triggered this build."
    properties:
        - build-discarder:
            days-to-keep: 40
            artifact-days-to-keep: 40
            numToKeep: 30
        - raw:
            xml: |
                <com.sonyericsson.rebuild.RebuildSettings plugin="rebuild@1.25">
                    <autoRebuild>false</autoRebuild>
                    <rebuildDisabled>false</rebuildDisabled>
                </com.sonyericsson.rebuild.RebuildSettings>
    publishers:
      - archive:
          artifacts: 'out/host/linux-x86/vcc_test_results/current/**/*'
          allow-empty: true
    notifications:
        - http:
            url: http://gotsvl1416.got.volvocars.net:3002/events
            format: json
            event: all
            timeout: 10000
            log: 0
    wrappers:
        - timestamps
        - timeout:
            timeout: 180
            timeout-var: 'BUILD_TIMEOUT'
            abort: true
            type: absolute
        - raw:
            xml: |
                    <org.jenkinsci.plugins.credentialsbinding.impl.SecretBuildWrapper plugin="credentials-binding@1.10">
                        <bindings>
                            <org.jenkinsci.plugins.credentialsbinding.impl.StringBinding>
                                <credentialsId>SWF1_ARTIFACTORY_API_KEY</credentialsId>
                                <variable>ARTIFACTORY_API_KEY</variable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.StringBinding>
                            <org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                                <credentialsId>17703053-422c-421c-a292-315cdb52c385</credentialsId>
                                <usernameVariable>MONGODB_USER</usernameVariable>
                                <passwordVariable>MONGODB_PASSWORD</passwordVariable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                            <org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                                <credentialsId>7cdd6d34-ee50-422a-9f18-8df67778b065</credentialsId>
                                <usernameVariable>INFLUXDB_USER</usernameVariable>
                                <passwordVariable>INFLUXDB_PASSWORD</passwordVariable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                        </bindings>
                    </org.jenkinsci.plugins.credentialsbinding.impl.SecretBuildWrapper>


- job:
    name: ihu_commit_check
    defaults: commit_job_defaults
    node: high
    builders:
        - shell:
            !include-raw:
                - bootstrap_common_commit_triggered.sh
                - bootstrap_ihu_commit_check.sh
- job:
    name: ihu_gate_build
    defaults: commit_job_defaults
    node: gate_build
    wrappers:
        - workspace-cleanup
        - timestamps
        - timeout:
            timeout: 180
            timeout-var: 'BUILD_TIMEOUT'
            abort: true
            type: absolute
        - raw:
            xml: |
                    <org.jenkinsci.plugins.credentialsbinding.impl.SecretBuildWrapper plugin="credentials-binding@1.10">
                        <bindings>
                            <org.jenkinsci.plugins.credentialsbinding.impl.StringBinding>
                                <credentialsId>SWF1_ARTIFACTORY_API_KEY</credentialsId>
                                <variable>ARTIFACTORY_API_KEY</variable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.StringBinding>
                            <org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                                <credentialsId>17703053-422c-421c-a292-315cdb52c385</credentialsId>
                                <usernameVariable>MONGODB_USER</usernameVariable>
                                <passwordVariable>MONGODB_PASSWORD</passwordVariable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                            <org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                                <credentialsId>7cdd6d34-ee50-422a-9f18-8df67778b065</credentialsId>
                                <usernameVariable>INFLUXDB_USER</usernameVariable>
                                <passwordVariable>INFLUXDB_PASSWORD</passwordVariable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                        </bindings>
                    </org.jenkinsci.plugins.credentialsbinding.impl.SecretBuildWrapper>

    workspace: /mnt/ramdisk/ihu_gate_build
    builders:
        - shell:
            !include-raw:
                - bootstrap_common_commit_triggered.sh
                - bootstrap_ihu_gate_build.sh
    publishers:
        - raw:
            xml: |
                <jenkinsci.plugins.influxdb.InfluxDbPublisher plugin="influxdb@1.14">
                <selectedTarget>influxdb</selectedTarget>
                <customProjectName>ihu_gate_build</customProjectName>
                <customPrefix>CommitGate</customPrefix>
                </jenkinsci.plugins.influxdb.InfluxDbPublisher>

- job:
    name: ihu_gate_test
    defaults: commit_job_defaults
    node: gate_test-generic
    wrappers:
        - workspace-cleanup
        - timestamps
        - timeout:
            timeout: 180
            timeout-var: 'BUILD_TIMEOUT'
            abort: true
            type: absolute
        - raw:
            xml: |
                    <org.jenkinsci.plugins.credentialsbinding.impl.SecretBuildWrapper plugin="credentials-binding@1.10">
                        <bindings>
                            <org.jenkinsci.plugins.credentialsbinding.impl.StringBinding>
                                <credentialsId>SWF1_ARTIFACTORY_API_KEY</credentialsId>
                                <variable>ARTIFACTORY_API_KEY</variable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.StringBinding>
                            <org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                                <credentialsId>17703053-422c-421c-a292-315cdb52c385</credentialsId>
                                <usernameVariable>MONGODB_USER</usernameVariable>
                                <passwordVariable>MONGODB_PASSWORD</passwordVariable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                            <org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                                <credentialsId>7cdd6d34-ee50-422a-9f18-8df67778b065</credentialsId>
                                <usernameVariable>INFLUXDB_USER</usernameVariable>
                                <passwordVariable>INFLUXDB_PASSWORD</passwordVariable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                        </bindings>
                    </org.jenkinsci.plugins.credentialsbinding.impl.SecretBuildWrapper>


    builders:
        - config-file-provider:
            files:
                - file-id: 61535809-5c5c-4721-9a65-e3587159647a
                  target: $HOME/lab_config.json
                  variable: IPM_MAP_FILE
        - shell:
            !include-raw:
                - bootstrap_common_commit_triggered.sh
                - bootstrap_ihu_gate_test.sh
    publishers:
        - raw:
            xml: |
                <jenkinsci.plugins.influxdb.InfluxDbPublisher plugin="influxdb@1.14">
                <selectedTarget>influxdb</selectedTarget>
                <customProjectName>ihu_gate_test</customProjectName>
                <customPrefix>CommitGate</customPrefix>
                </jenkinsci.plugins.influxdb.InfluxDbPublisher>

- job:
    name: ihu_gate_test_flexray
    defaults: commit_job_defaults
    node: gate_test-flexray
    builders:
        - config-file-provider:
            files:
                - file-id: 61535809-5c5c-4721-9a65-e3587159647a
                  target: $HOME/lab_config.json
                  variable: IPM_MAP_FILE
        - shell:
            !include-raw:
                - bootstrap_common_commit_triggered.sh
                - bootstrap_ihu_gate_test.sh

- job:
    name: ihu_gate_test_audio
    defaults: commit_job_defaults
    node: gate_test-audio
    builders:
        - config-file-provider:
            files:
                - file-id: 61535809-5c5c-4721-9a65-e3587159647a
                  target: $HOME/lab_config.json
                  variable: IPM_MAP_FILE
        - shell:
            !include-raw:
                - bootstrap_common_commit_triggered.sh
                - bootstrap_ihu_gate_test.sh

- job:
    name: ihu_gate_test_apix
    defaults: commit_job_defaults
    node: gate_test-apix
    builders:
        - config-file-provider:
            files:
                - file-id: 61535809-5c5c-4721-9a65-e3587159647a
                  target: $HOME/lab_config.json
                  variable: IPM_MAP_FILE
        - shell:
            !include-raw:
                - bootstrap_common_commit_triggered.sh
                - bootstrap_ihu_gate_test.sh

- job:
    name: ihu_check_build
    defaults: commit_job_defaults
    node: gate_build
    workspace: /mnt/ramdisk/ihu_gate_build
    builders:
        - shell:
            !include-raw:
                - bootstrap_ihu_gate_build_stage.sh
                - bootstrap_ihu_gate_build.sh
    publishers:
        - raw:
            xml: |
                <jenkinsci.plugins.influxdb.InfluxDbPublisher plugin="influxdb@1.14">
                <selectedTarget>influxdb</selectedTarget>
                <customProjectName>ihu_check_build</customProjectName>
                <customPrefix>CommitGate</customPrefix>
                </jenkinsci.plugins.influxdb.InfluxDbPublisher>

- job:
    name: ihu_check_test
    defaults: commit_job_defaults
    node: gate_test-generic
    builders:
        - config-file-provider:
            files:
                - file-id: 61535809-5c5c-4721-9a65-e3587159647a
                  target: $HOME/lab_config.json
                  variable: IPM_MAP_FILE
        - shell:
            !include-raw:
                - bootstrap_common_commit_triggered.sh
                - bootstrap_ihu_gate_test.sh
    publishers:
        - raw:
            xml: |
                <jenkinsci.plugins.influxdb.InfluxDbPublisher plugin="influxdb@1.14">
                <selectedTarget>influxdb</selectedTarget>
                <customProjectName>ihu_check_test</customProjectName>
                <customPrefix>CommitGate</customPrefix>
                </jenkinsci.plugins.influxdb.InfluxDbPublisher>
- project:
    name: ihu
    node: master
    jobs:
      - ihu_commit_check
      - ihu_gate_build
      - ihu_gate_test
      - ihu_gate_test_flexray
      - ihu_gate_test_audio
