- defaults:
    name: staging_job_defaults
    project-type: freestyle
    description: DO NOT EDIT MANUALLY THROUGH JENKINS WEB UI - Config in vendor/volvocars/tools/ci/jenkins_job_builder
    concurrent: false
    parameters:
        - run:
            name: UPSTREAM_JOB
            project-name: ihu_daily_build_vcc_eng
            description: UPSTREAM_JOB can be used to fetch info about the build.
        - run:
            name: TOP_JOB
            project-name: ihu_staging
            description: parameter 'TOP_JOB_NUMBER' will be used to store along with test results.            
    properties:
        - build-discarder:
            days-to-keep: 30
            artifact-days-to-keep: 30
        - raw:
            xml: |
                <com.sonyericsson.rebuild.RebuildSettings plugin="rebuild@1.25">
                    <autoRebuild>false</autoRebuild>
                    <rebuildDisabled>false</rebuildDisabled>
                </com.sonyericsson.rebuild.RebuildSettings>
    wrappers:
        - timestamps
        - timeout:
            timeout: 240
            timeout-var: 'BUILD_TIMEOUT'
            abort: true
            type: absolute
        - raw:
            xml: |
                    <org.jenkinsci.plugins.credentialsbinding.impl.SecretBuildWrapper plugin="credentials-binding@1.10">
                        <bindings>
                            <org.jenkinsci.plugins.credentialsbinding.impl.StringBinding>
                                <credentialsId>SWF1_ARTIFACTORY_API_KEY</credentialsId>
                                <variable>ARTIFACTORY_API_KEY</variable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.StringBinding>
                            <org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                                <credentialsId>17703053-422c-421c-a292-315cdb52c385</credentialsId>
                                <usernameVariable>MONGODB_USER</usernameVariable>
                                <passwordVariable>MONGODB_PASSWORD</passwordVariable>
                            </org.jenkinsci.plugins.credentialsbinding.impl.UsernamePasswordMultiBinding>
                        </bindings>
                    </org.jenkinsci.plugins.credentialsbinding.impl.SecretBuildWrapper>

- job:
    name: ihu_staging
    project-type: multijob
    description: Link to test report - http://gotsvl1416.got.volvocars.net/staging_test_report/<BUILD_NUMBER>
    node: high
    parameters:
        - run:
            name: UPSTREAM_JOB
            project-name: ihu_daily_build_vcc_eng
            description: UPSTREAM_JOB can be used to fetch info about the build.
        - string:
            name: GIT_COMMIT
            default: ''
            description: Normally sent from the triggering job (ihu_daily)
        - string:
            name: GIT_URL
            default: ''
            description: Normally sent from the triggering job (ihu_daily)
    builders:
        - shell: |
            if [ "$UPSTREAM_JOB_RESULT" != "SUCCESS" ]
            then
                echo "Build job failed!!!"
                exit 1
            fi
        - multijob:
            name: Staging
            condition: ALWAYS
            projects:
              - name: ihu_staging_test-generic
                current-parameters: true
                predefined-parameters: |
                  UPSTREAM_JOB_GIT_REVISION=${GIT_COMMIT}
                  UPSTREAM_JOB_GIT_URL=${GIT_URL}
              - name: ihu_staging_test-flexray
                current-parameters: true
                kill-phase-on: NEVER
                predefined-parameters: |
                  UPSTREAM_JOB_GIT_REVISION=${GIT_COMMIT}
                  UPSTREAM_JOB_GIT_URL=${GIT_URL}
              - name: ihu_staging_test-audio
                current-parameters: true
                kill-phase-on: NEVER
                predefined-parameters: |
                  UPSTREAM_JOB_GIT_REVISION=${GIT_COMMIT}
                  UPSTREAM_JOB_GIT_URL=${GIT_URL}
              - name: ihu_staging_test-apix
                current-parameters: true
                kill-phase-on: NEVER
                predefined-parameters: |
                  UPSTREAM_JOB_GIT_REVISION=${GIT_COMMIT}
                  UPSTREAM_JOB_GIT_URL=${GIT_URL}
    publishers:
        - raw:
            xml: |
                <jenkinsci.plugins.influxdb.InfluxDbPublisher plugin="influxdb@1.14">
                <selectedTarget>influxdb</selectedTarget>
                <customProjectName>ihu_staging</customProjectName>
                <customPrefix>IhuStagingMaster</customPrefix>
                </jenkinsci.plugins.influxdb.InfluxDbPublisher>

- job:
    name: ihu_staging_test-generic
    defaults: staging_job_defaults
    node: daily_test-generic
    builders:
        - config-file-provider:
            files:
                - file-id: 61535809-5c5c-4721-9a65-e3587159647a
                  target: $HOME/lab_config.json
                  variable: IPM_MAP_FILE
        - shell: |
            if [ "$UPSTREAM_JOB_RESULT" != "SUCCESS" ]
            then
                echo "Build job failed!!!"
                exit 1
            fi
        - shell:
            !include-raw:
                - bootstrap_ihu_daily_common.sh
                - bootstrap_common_time_triggered.sh
                - bootstrap_ihu_staging_test_common.sh

- job:
    name: ihu_staging_test-flexray
    defaults: staging_job_defaults
    node: daily_test-flexray
    builders:
        - config-file-provider:
            files:
                - file-id: 61535809-5c5c-4721-9a65-e3587159647a
                  target: $HOME/lab_config.json
                  variable: IPM_MAP_FILE
        - shell: |
            if [ "$UPSTREAM_JOB_RESULT" != "SUCCESS" ]
            then
                echo "Build job failed!!!"
                exit 1
            fi
        - shell:
            !include-raw:
                - bootstrap_ihu_daily_common.sh
                - bootstrap_common_time_triggered.sh
                - bootstrap_ihu_staging_test_common.sh

- job:
    name: ihu_staging_test-audio
    defaults: staging_job_defaults
    node: daily_test-audio
    builders:
        - config-file-provider:
            files:
                - file-id: 61535809-5c5c-4721-9a65-e3587159647a
                  target: $HOME/lab_config.json
                  variable: IPM_MAP_FILE
        - shell: |
            if [ "$UPSTREAM_JOB_RESULT" != "SUCCESS" ]
            then
                echo "Build job failed!!!"
                exit 1
            fi
        - shell:
            !include-raw:
                - bootstrap_ihu_daily_common.sh
                - bootstrap_common_time_triggered.sh
                - bootstrap_ihu_staging_test_common.sh

- job:
    name: ihu_staging_test-apix
    defaults: staging_job_defaults
    node: daily_test-apix
    builders:
        - config-file-provider:
            files:
                - file-id: 61535809-5c5c-4721-9a65-e3587159647a
                  target: $HOME/lab_config.json
                  variable: IPM_MAP_FILE
        - shell: |
            if [ "$UPSTREAM_JOB_RESULT" != "SUCCESS" ]
            then
                echo "Build job failed!!!"
                exit 1
            fi
        - shell:
            !include-raw:
                - bootstrap_ihu_daily_common.sh
                - bootstrap_common_time_triggered.sh
                - bootstrap_ihu_staging_test_common.sh
