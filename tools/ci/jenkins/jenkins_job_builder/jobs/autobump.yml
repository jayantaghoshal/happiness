- job:
    name: icup_android_manifest_bump
    # TODO: temp_only_high_because_right_now_repo_is_not_installed_on_low
    # TODO: The script is not even using repo????, node-filter not relevant            
    node: high 
    description: DO NOT EDIT MANUALLY THROUGH JENKINS WEB UI - Config in vendor/volvocars/tools/ci/jenkins_job_builder
    
    triggers:
        - gerrit:  
            server-name: 'iCUP Android Gerrit'
            silent: true
            trigger-on: 
                - change-merged-event 
            projects:
                - project-compare-type: 'PLAIN'
                  project-pattern: 'vendor/volvocars'
                  branches:
                    - branch-compare-type: 'REG_EXP'
                      branch-pattern: '.*'
                - project-compare-type: 'PLAIN'
                  project-pattern: 'aic_test'
                  branches:
                    - branch-compare-type: 'REG_EXP'
                      branch-pattern: '.*'
                - project-compare-type: 'PLAIN'
                  project-pattern: 'vendor/volvocars/apps/ihu_test'
                  branches:
                    - branch-compare-type: 'REG_EXP'
                      branch-pattern: '.*'
                - project-compare-type: 'PLAIN'
                  project-pattern: 'vendor/volvocars/apps/tunerbrowserservice'
                  branches:
                    - branch-compare-type: 'REG_EXP'
                      branch-pattern: '.*'
                - project-compare-type: 'PLAIN'
                  project-pattern: 'vendor/volvocars/hmi/Launcher'
                  branches:
                    - branch-compare-type: 'REG_EXP'
                      branch-pattern: '.*'
                - project-compare-type: 'PLAIN'
                  project-pattern: 'vendor/volvocars/hmi/MediaLibrary'
                  branches:
                    - branch-compare-type: 'REG_EXP'
                      branch-pattern: '.*'
                - project-compare-type: 'PLAIN'
                  project-pattern: 'vendor/volvocars/hmi/SystemDialog'
                  branches:
                    - branch-compare-type: 'REG_EXP'
                      branch-pattern: '.*'
    scm:
        - git:
            url: ssh://gotsvl1415.got.volvocars.net:29421/vendor/volvocars
            credentials-id: 0cc7da38-6d74-4a55-8773-e706f59cb82f
            branches:
                - "*/${GERRIT_BRANCH}"
            basedir: vendor/volvocars
    notifications:
        - http:
            url: http://gotsvl1416.got.volvocars.net:3002/events
            format: json
            event: all
            timeout: 10000
            log: 0
    builders:
        - shell: |
                export WORKSPACE_ROOT=$(pwd)
                export PYTHONPATH=$PYTHONPATH:./vendor/volvocars/tools/lib/python
                ##  Fake the directory structure of "repo" because the bump.py script assumes default AOSP structure.
                # TODO: Move this inside the autobump.py script
                # Can't use git clone because directory might exist from last run
                mkdir -p .repo/manifests
                cd .repo/manifests
                git init
                if ! git config remote.origin.url > /dev/null; then
                   git remote add origin ssh://gotsvl1415.got.volvocars.net:29421/manifest
                fi
                git fetch --tags --progress origin "${GERRIT_BRANCH}"
                git checkout "${GERRIT_BRANCH}"
                git reset --hard origin/"${GERRIT_BRANCH}"
                cd "${WORKSPACE_ROOT}"

                # Download repo if it repo is not vendor/volvocars
                if [ ! "$GERRIT_PROJECT" == "vendor/volvocars" ]; then
                    python3 ./vendor/volvocars/tools/ci/shipit/bump.py . sync_repo_based_on_manifest "${GERRIT_PROJECT}"
                fi

                ## Update the manifests based on the templates and push it
                python3 ./vendor/volvocars/tools/ci/shipit/bump.py . autobump "${GERRIT_BRANCH}" "${BUILD_URL}" "${GERRIT_PROJECT}"
    publishers:
        - raw:
            xml: |
                <jenkinsci.plugins.influxdb.InfluxDbPublisher plugin="influxdb@1.14">
                <selectedTarget>influxdb</selectedTarget>
                <customProjectName>icup_android_manifest_bump</customProjectName>
                <customPrefix>IhuManifestBump</customPrefix>
                </jenkinsci.plugins.influxdb.InfluxDbPublisher>
        - description-setter:
            regexp-for-failed: "fatal: (.*)"

