# Copyright 2017 Volvo Car Corporation
# This file is covered by LICENSE file in the root of this project

#!/usr/bin/env python
import os
import json
import http.client
import requests
import time

os.system("python3 $REPO_ROOT_DIR/vendor/volvocars/tools/test/cloud_sim/server.py &")
time.sleep(2) #wait for server to come up

os.system("adb reverse tcp:8081 tcp:8081")
print("adb reverse tcp:8081 tcp:8081")
server_ip_and_port = "localhost:8081"
server_ip = "localhost"
data = {}
req = {}
#header = {}
rsp = ""
req['type'] = "GET"
req['path'] = "/cloud/"
req['version'] = "HTTP/1.0"
#header['Accept'] =  "*/*" #"application/volvo.cloud.EntryPoint+XML" Fix correct in test cloudd deamon 
#req["headers"] = [header]
fo = open("entrypoint.xml", "r")
rsp = fo.readline()
data['request'] = req
data['response'] = rsp
jsondata = json.dumps(data, indent=4)

conn = http.client.HTTPConnection(server_ip, 8081)
conn.request("PUT", server_ip_and_port +"/cloud", jsondata)
conn.close()
req['path'] = "/cloud"
data['request'] = req
jsondata = json.dumps(data, indent=4)
conn = http.client.HTTPConnection(server_ip, 8081)
conn.request("PUT",  server_ip_and_port +"/cloud", jsondata)
conn.close()

#PreSetup Test
os.system("adb push $REPO_ROOT_DIR/vendor/volvocars/hardware/cloudd/test/ct/vtscloud/localconfig_cloud.json data/local/tmp/localconfig_cloud.json")
os.system("adb shell killall -9 cloudd")
os.system("adb shell killall -9 vendor.volvocars.cloudservice")
os.system("adb shell setprop service.cloudservice.use_https 0")
os.system("adb shell VCC_LOCALCONFIG_PATH=/data/local/tmp/localconfig_cloud.json /vendor/bin/hw/cloudd &")